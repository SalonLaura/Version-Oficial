{% extends base %}
{% load static custom_filters %}

{% block styles %}
<script src="{% static 'js/datepicker.min.js' %}"></script>
{% endblock styles %}
                
{% block content %}

<div class="flex flex-col p-6 w-full h-[calc(100%-1rem)]">
    <form class="h-auto bg-white rounded-t-lg shadow-sm dark:bg-gray-800 w-full p-3 space-y-3" method="GET">
        <div class="flex space-x-3">
            <select id="" name="operacion" class="w-1/4 bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-purple-500 focus:border-purple-500 block p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-purple-500 dark:focus:border-purple-500">
                <option value="es" {% if operacion == "es" %}selected{% endif %}>Entradas y salidas</option>
                <option value="se" {% if operacion == "se" %}selected{% endif %}>Solo entradas</option>
                <option value="ss" {% if operacion == "ss" %}selected{% endif %}>Solo salidas</option>
            </select>

            <button id="dropdownSelectProductoButton" data-dropdown-toggle="dropdownSelectProducto" data-dropdown-placement="bottom" class="flex items-center justify-between w-1/4 bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-purple-500 focus:border-purple-500 block p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-purple-500 dark:focus:border-purple-500" type="button">
                {% if producto_select %}{{producto_select.nombre}}{% else %}Todos los productos{% endif %}
                <svg class="w-2.5 h-2.5 ml-2.5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="m1 1 4 4 4-4"/>
                </svg>
            </button>
            

            <select id="" name="almacen" class="w-1/4 bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-purple-500 focus:border-purple-500 block p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-purple-500 dark:focus:border-purple-500">
                {% for alm in almacenes %}
                <option value="{{ alm.id }}" {% if alm == almacen_select %}selected{% endif %}>{{ alm.nombre }}</option>
                {% endfor %}
            </select>
            
            <button class="w-1/4 flex items-center justify-center  p-2.5 text-sm font-medium leading-5 text-gray-600 hover:text-gray-800 shadow-sm hover:shadow-lg bg-gray-200 hover:bg-gray-300 border border-transparent rounded-lg focus:outline-none focus:shadow-outline-gray" type="submit">
                <svg class="w-5 h-5 mr-2" aria-hidden="true" fill="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3c2.755 0 5.455.232 8.083.678.533.09.917.556.917 1.096v1.044a2.25 2.25 0 01-.659 1.591l-5.432 5.432a2.25 2.25 0 00-.659 1.591v2.927a2.25 2.25 0 01-1.244 2.013L9.75 21v-6.568a2.25 2.25 0 00-.659-1.591L3.659 7.409A2.25 2.25 0 013 5.818V4.774c0-.54.384-1.006.917-1.096A48.32 48.32 0 0112 3z"></path>
                </svg>
                Filtrar Almacén
            </button>
        </div>
        <!--<div class="flex space-x-3" date-rangepicker >
            <div class="relative w-1/3">
                <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                    <svg aria-hidden="true" class="w-5 h-5 text-gray-500 dark:text-gray-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path></svg>
                </div>
                <input name="inicio" value="{{inicio}}" type="text" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full pl-10 p-2.5  dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" placeholder="Desde">
            </div>
            <div class="relative w-1/3">
                <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                    <svg aria-hidden="true" class="w-5 h-5 text-gray-500 dark:text-gray-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path></svg>
                </div>
                <input name="fin" type="text" value="{{fin}}" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full pl-10 p-2.5  dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" placeholder="Hasta">
            </div> 
        </div>-->
        
        <!-- Dropdown menu -->
        <div id="dropdownSelectProducto" class="z-10 hidden bg-white rounded-lg shadow-xl border w-72 dark:bg-gray-700">
            
            <div class="p-3">
                <label for="input-producto-search" class="sr-only">Search</label>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                        <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m19 19-4-4m0-7A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z"/>
                        </svg>
                    </div>
                    <input type="text" id="input-producto-search" oninput="searchProducto()" class="block w-full p-2 pl-10 text-sm text-gray-900 border border-gray-300 rounded-lg bg-gray-50 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" placeholder="Filtrar producto"/>
                </div>
            </div>
            <ul class="max-h-96 px-3 pb-3 overflow-y-auto text-sm text-gray-700 dark:text-gray-200" aria-labelledby="dropdownSelectProductoButton">
                <li class="hidden">
                    <div class="flex items-center p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-600">
                        <input checked id="default-producto" type="radio" value="" name="producto" class="w-3 h-3 text-gray-600 bg-gray-100 border-gray-300 focus:ring-gray-500 dark:focus:ring-gray-600 dark:ring-offset-gray-700 dark:focus:ring-offset-gray-700 focus:ring-2 dark:bg-gray-600 dark:border-gray-500"/>
                        <label for="default-producto" class="w-full ml-2 text-sm font-medium text-gray-900 rounded dark:text-gray-300">Todos los productos</label>
                    </div>
                </li>
                {% for producto in productos %}
                <li class="producto-input">
                    <div class="flex items-center p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-600">
                        <input {% if producto == producto_select %}checked{% endif %} id="{{ producto.id }}" type="radio" value="{{ producto.id }}" name="producto" class="w-3 h-3 text-gray-600 bg-gray-100 border-gray-300 focus:ring-gray-500 dark:focus:ring-gray-600 dark:ring-offset-gray-700 dark:focus:ring-offset-gray-700 focus:ring-2 dark:bg-gray-600 dark:border-gray-500"/>
                        <label for="{{ producto.id }}" class="producto-label w-full ml-2 text-sm font-medium text-gray-900 rounded dark:text-gray-300">{{ producto.nombre }}</label>
                    </div>
                </li>
                {% endfor %}
            </ul>
        </div>
    </form>
    <div class="w-full flex justify-center h-[calc(100%-3rem)]">
        <div class="w-full bg-white dark:bg-gray-900 shadow-md rounded-b-lg p-1.5 overflow-x-auto">
            <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400 ">
                <thead class="">
                    <tr class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400 sticky top-0">
                        <th scope="col" class="px-6 py-3 truncate"> Fecha </th>
                        <th scope="col" class="px-6 py-3 truncate"> Descripción</th>
                        <th scope="col" class="px-6 py-3 truncate"> U/M</th>
                        <th scope="col" class="px-6 py-3 truncate"> Entradas</th>
                        <th scope="col" class="px-6 py-3 truncate"> Salidas</th>
                        <th scope="col" class="px-6 py-3 truncate"> Saldo</th>
                        <th scope="col" class="px-6 py-3 truncate"> Destino</th>
                        <th scope="col" class="px-6 py-3 truncate"> Operación</th>
                        
                    </tr>
                </thead>
                <tbody>
                    
                    {% for producto in entradas_salidas %}
                    
                    {% if producto.transformacion and operacion != "se" %}
                    {% if not producto_select or  producto.transformacion.producto_inicial == producto_select %}
                    <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                        <td class="px-6 py-4 truncate">{% if producto.fecha %}{{producto.fecha}}{% elif producto.alta %}{{producto.alta}}{% else %}{{producto.date_confirm}}{% endif %}</td>
                        <th scope="row" class="flex items-center px-6 py-4 text-gray-900 whitespace-nowrap dark:text-white">
                            {% if producto.transformacion.producto_inicial.img %}
                            <img class="rounded-full w-8 h-8" src="{{producto.transformacion.producto_inicial.img}}" alt="" />
                            {% else %}
                            <p class="rounded-full w-8 h-8 flex items-center justify-center font-bold text-md text-gray-600 bg-gray-100">{{ producto.transformacion.producto_inicial.nombre.0 }}{{ producto.transformacion.producto_inicial.nombre.1 }}<p>
                            {% endif %}
                            <div class="text-base font-semibold truncate text-xs ml-3">{{ producto.transformacion.producto_inicial.nombre }}</div> 
                        </th>
                        <td class="px-6 py-4 truncate">{{ producto.transformacion.producto_inicial.medida.abreviatura }}</td> 
                        <td class="px-6 py-4 truncate">-</td> 
                        <td class="px-6 py-4 truncate">{% with producto.cantidad_inicial|multiplica:producto.transformacion.cantidad_inicial|divide:producto.transformacion.cantidad_final as salida %}{{salida}}{% endwith %}</td> 
                        <td class="px-6 py-4 truncate">{{ producto.existencia|mod }}</td> 
                        <td class="px-6 py-4 truncate"> {{ producto.destino.nombre }} </td>
                        <td class="px-6 py-4 truncate"> Transformación </td>
                    </tr>
                    {% endif %}
                    {% endif %}

                    {% if not producto_select or  producto.producto == producto_select %}
                    {% if not producto.transformacion or operacion != "ss" %}
                    <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                        <td class="px-6 py-4 truncate">{% if producto.fecha %}{{producto.fecha}}{% elif producto.alta %}{{producto.alta}}{% else %}{{producto.date_confirm}}{% endif %}</td>
                        <th scope="row" class="flex items-center px-6 py-4 text-gray-900 whitespace-nowrap dark:text-white">
                            {% if producto.producto.img %}
                            <img class="rounded-full w-8 h-8" src="{{producto.transformacion.producto_inicial.img}}" alt="" />
                            {% else %}
                            <p class="rounded-full w-8 h-8 flex items-center justify-center font-bold text-md text-gray-600 bg-gray-100">{{ producto.producto.nombre.0 }}{{ producto.producto.nombre.1 }}<p>
                            {% endif %}
                            <div class="text-base font-semibold truncate text-xs ml-3">{{ producto.producto.nombre }}</div> 
                        </th>

                        <td class="px-6 py-4 truncate">{{ producto.producto.medida.abreviatura }}</td> 
                        <td class="px-6 py-4 truncate">
                            {% if producto.type_ == "StockAlmacen" %}
                                {% if producto.informe_recepcion %}
                                {{producto.cantidad_inicial}}
                                {% elif producto.transferencia and almacen_select == producto.transferencia.receptor %}
                                {{producto.cantidad_inicial}}
                                {% elif producto.transformacion %}
                                {{producto.cantidad_inicial}}
                                {% else %}
                                
                                {% endif %}
                                
                            {% elif producto.type_ == "CambiosAlmacen"%}{% if producto.cantidad < 0  %}-{% else %}{{producto.cantidad|mod|parseFloat}}{% endif %}
                            {% elif producto.type_ == "StockPuntoVenta" or producto.type_ == "StockCocina" or producto.type_ == "BolsaEstudio" or producto.type_ == "Trabajador" %}-{% endif %}
                        </td> 
                        <td class="px-6 py-4 truncate">
                            {% if producto.type_ == "StockAlmacen" %}
                                {% if producto.informe_recepcion %}
                                -
                                {% elif producto.transferencia and almacen_select == producto.transferencia.receptor %}
                                -
                                {% elif producto.transformacion %}
                                -
                                {% else %}
                                {{producto.cantidad_inicial}}
                                {% endif %}
                                
                            {% elif producto.type_ == "CambiosAlmacen"%}{% if producto.cantidad > 0  %}-{% else %}{{producto.cantidad|mod|parseFloat}}{% endif %}
                            {% elif producto.type_ == "StockPuntoVenta" or producto.type_ == "StockCocina" or producto.type_ == "BolsaEstudio" or producto.type_ == "Trabajador" %}{{producto.cantidad_remitida}}{% endif %}
                        </td>
                        <td class="px-6 py-4 truncate">
                            {% if almacen_select == producto.transferencia.receptor  or producto.transformacion %}
                            {{ producto.existencia_receptor|mod }}
                            {% else %}
                            {{ producto.existencia|mod }}
                            {% endif %}
                        </td>   
                        <td class="px-6 py-4 truncate">
                            {{ producto.destino.nombre }}
                        </td>
                        <td class="px-6 py-4 truncate"> {{ producto.operacion }} </td>
                    </tr>
                    {% endif %}

                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock content %}


{% block scripts %}

<script type = "text/JavaScript">
    function searchProducto(){
        let elements = document.getElementsByClassName("producto-input");
        let labels = document.getElementsByClassName("producto-label");
        let txt = document.getElementById("input-producto-search").value;

        for (let i = 0; i < labels.length; i++) {
            
            if (labels[i].innerText.toLowerCase().includes(txt)) {
                elements[i].classList.remove("hidden");
            } else {
                elements[i].classList.add("hidden");
            }
        }
    }
</script>
{% endblock scripts %}